name: Analyze PowerShell Script

on: [push, pull_request]

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - run: ls
    - run: pwd

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        check-latest: true
    
    - run: java --version
    
    - name: Run PSScriptAnalyzer
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        $results = Invoke-ScriptAnalyzer -Path store-container-manager.ps1 -Settings PSScriptAnalyzerSettings.psd1
        $results | ConvertTo-Csv | Out-File analysis-results-2.csv 
      shell: pwsh

    - name: setup python
      uses: actions/setup-python@v5
      with:
        # Semantic version range syntax or exact version of a Python version
        python-version: '3.x'
        # Optional - x64 or x86 architecture, defaults to x64
        architecture: 'x64'
    - name: run python script
      run: |
        python convert_results.py
    
    - run: ls
    - name: Install and push external package to Sonar server in azure
      run: |
        wget -O sonar-scanner-cli.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
        unzip sonar-scanner-cli.zip -d $HOME
        export PATH="$HOME/sonar-scanner-4.6.2.2472-linux/bin:$PATH"
        
    - name: run sonnar-scaner
      run: |
        sonar-scanner \
          -Dsonar.projectKey=powershell \
          -Dsonar.sources=. \
          -Dsonar.host.url=http://20.81.187.233:9000 \
          -Dsonar.login=sqp_13bc0363190429f734aed26be227d32fa8665a7a \
          -Dsonar.sarifReportPaths=result.sarif \
          -Dsonar.exclusions=convert_results.py
